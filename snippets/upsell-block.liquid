{%- liquid
  assign use_auto_collection = block.settings.enable_dynamic_recommendations
  assign current_product = product
  assign bl_pool_key = product.metafields.custom.collection_key.value | default: product.metafields.custom.collection_key | strip | downcase
  assign bl_pool_title = ''

  assign bl_pool_handle = bl_pool_key

  if bl_pool_handle != blank
    assign bl_pool_collection = collections[bl_pool_handle]
    if bl_pool_collection
      assign bl_pool_title = bl_pool_collection.title | strip | escape
    endif
  endif

  if bl_pool_title == blank and bl_pool_handle != blank
    assign bl_pool_title = bl_pool_handle | replace: '-', ' ' | replace: '_', ' ' | capitalize | strip | escape
  endif

  # ----------------------------
  # ADD-ON CONFIG
  # ----------------------------
  assign addon_handle = 'mystery-add-on'
  assign addon_product = all_products[addon_handle]

  assign bl_addon_enabled = false
  if addon_product != blank and bl_pool_key != blank
    assign bl_addon_enabled = true
  endif

  # ----------------------------
  # PRODUCT LIST (POOL)
  # ----------------------------
  assign product_list = block.settings.product_list
  assign hidden_products = 0
  assign bl_pool_total = 0

  if use_auto_collection
    assign source_collection = collections[block.settings.upsell_collection]

    if source_collection != blank
      assign product_list = source_collection.products
    endif
  endif

  assign pool_count = 0
  if product_list != blank
    assign pool_count = product_list.size
  endif

  # ----------------------------
  # DISPLAY COUNT (UI ONLY)
  # We still render the full pool so JS can randomize.
  # ----------------------------
  assign normal_visible = 3
  if bl_addon_enabled
    assign normal_visible = 2
  endif

  assign display_count = 0
  if pool_count > 0
    assign display_count = pool_count
    if display_count > normal_visible
      assign display_count = normal_visible
    endif
  endif

  if bl_addon_enabled
    assign display_count = display_count | plus: 1
  endif
-%}

{%- comment -%}
  Canonical pool context for mystery add-on + rarity availability (consumed by JS).
{%- endcomment -%}
{%- if type != 'product-info' -%}
  {% render 'bl-pool-context', product: product, collection: collection %}
{%- endif -%}

<div
  class='{{ type }}-upsells-container{% if display_count > 1 and block.settings.stacking == "column" %} upsells-container--stacked-columns{% endif %}{% if display_count > 1 and block.settings.stacking == "slider" %} side-margins-negative{% endif %}'
  style="
    --item-count: {{ display_count }};
    --image-size: {{ block.settings.images_size }}rem;
    --image-size-number: {{ block.settings.images_size }};
    --image-border-radius: {{ block.settings.images_corner_radius | divided_by: 10.0 }}rem;
    --title-font-size: {{ block.settings.title_size }}rem;
    --desc-font-size: {{ block.settings.desc_size }}rem;
    --price-font-size: {{ block.settings.price_size }}rem;
    --border-radius: {{ block.settings.corner_radius | divided_by: 10.0 }}rem;
    --regular-border-color: {{ block.settings.regular_border_color }};
    --selected-border-color: {{ block.settings.selected_border_color }};
    --border-width: {{ block.settings.border_width }}rem;
    --regular-bg-color: {{ block.settings.regular_bg_color }};
    --selected-bg-color: {{ block.settings.selected_bg_color }};
    --margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;
    --margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;
  "
  id='UpsellsBlock-{{ section.id }}-{{ block.id }}'
  data-count="{{ display_count }}"
  data-random-upsells="{% if use_auto_collection %}true{% else %}false{% endif %}"
  data-product-handle="{{ current_product.handle }}"
  {{ block.shopify_attributes }}
>
  {% if display_count == 0 %}
    <h4 class='center'>Assign upsell products in block settings or choose a collection.</h4>
  {% endif %}

  {% if block.settings.container_title != blank and block.settings.container_title_position == 'outside' and display_count != 0 %}
    <h3
      class='upsell__outside-title center custom-font-size'
      style='--mobile-text-size: {{ block.settings.container_title_mobile_text_size | divided_by: 10.0 }}rem;--desktop-text-size: {{ block.settings.container_title_desktop_text_size | divided_by: 10.0 }}rem;'
    >
      {{ block.settings.container_title }}
    </h3>
  {% endif %}

  {% if display_count > 1 and block.settings.stacking == 'slider' %}
    {%- liquid
      assign side_padding = '15'
      assign gap = '45'
    -%}
    <splide-component
      data-type='slide'
      data-arrows='false'
      data-gap-desktop="{{ gap }}"
      data-gap-mobile="{{ gap }}"
      data-side-padding-desktop="{{ side_padding }}"
      data-side-padding-mobile="{{ side_padding }}"
      data-slides-desktop="1"
      data-slides-mobile="1"
      style="--side-padding-desktop:{{ side_padding }};--side-padding-mobile:{{ side_padding }};"
    >
      <div class='splide splide--desktop-dots-under splide--mobile-dots-under'>
        <div class='splide__track'>
          <ul class="splide__list">
  {% endif %}

  {%- if product_list != blank -%}
    {%- for upsell_product in product_list -%}

      {%- if use_auto_collection and upsell_product.id == current_product.id -%}
        {%- continue -%}
      {%- endif -%}

      {%- liquid
        assign product = upsell_product
        assign bl_pool_total = bl_pool_total | plus: 1

        # Slot settings (1/2/3) – items beyond 3 use slot 3 styling/discounts
        if forloop.index == 1
          assign preselected = block.settings.prdouct_1_preselected
          assign featured_image = block.settings.product_1_image
          assign description = block.settings.product_1_desc
          assign percentage_discount = block.settings.product_1_percentage_discount | plus: 0
          assign fixed_discount = block.settings.product_1_fixed_amount_discount | times: 100.0
        elsif forloop.index == 2
          assign preselected = block.settings.prdouct_2_preselected
          assign featured_image = block.settings.product_2_image
          assign description = block.settings.product_2_desc
          assign percentage_discount = block.settings.product_2_percentage_discount | plus: 0
          assign fixed_discount = block.settings.product_2_fixed_amount_discount | times: 100.0
        else
          assign preselected = block.settings.prdouct_3_preselected
          assign featured_image = block.settings.product_3_image
          assign description = block.settings.product_3_desc
          assign percentage_discount = block.settings.product_3_percentage_discount | plus: 0
          assign fixed_discount = block.settings.product_3_fixed_amount_discount | times: 100.0
        endif

        assign percentage_left = 100.0 | minus: percentage_discount | divided_by: 100.0

        assign price = product.first_available_variant.price | times: percentage_left | minus: fixed_discount
        assign compare_price = product.first_available_variant.price
        if product.first_available_variant.compare_at_price > product.first_available_variant.price
          assign compare_price = product.first_available_variant.compare_at_price
        endif

        assign variants_available_arr = product.variants | map: 'available'
        assign variants_option1_arr = product.variants | map: 'option1'
        assign variants_option2_arr = product.variants | map: 'option2'
        assign variants_option3_arr = product.variants | map: 'option3'

        assign product_form_id = type | append: 'upsell' | append: block.id | append: forloop.index

        assign display = true

        if block.settings.hide_in_cart_items and block.settings.style == 'add_button'
          for item in cart.items
            if item.product.handle == product.handle
              assign display = false
              assign hidden_products = hidden_products | plus: 1
              break
            endif
          endfor
        endif

        if product.available == false
          assign display = false
          assign hidden_products = hidden_products | plus: 1
        endif
      -%}

      {%- if display -%}
        {%- capture bl_upsell_card -%}

          {% if type == 'cart-drawer' and block.settings.style != 'add_button' %}
            <style>
              .cart-drawer .cart-item--product-{{ product.handle }} { display: none; }
            </style>
          {% endif %}

          <{{ type }}-upsell
            class='upsell upsell--{{ block.settings.style }} {{ type }}-upsell-{{ section.id }} upsell--btn-{{ block.settings.btn_position }} color-{{ block.settings.color_scheme }} accent-color-{{ block.settings.accent_color }}{% if block.settings.show_custom_bg %} upsell--custom-bg{% endif %}{% if block.settings.show_box_shadow %} upsell--box-shadow{% endif %}{% if block.settings.show_border %} upsell--border{% endif %}'
            data-style="{{ block.settings.style }}"
            data-selected="{{ preselected }}"
            data-handle="{{ product.handle }}"
            data-toggle="{% if block.settings.style == 'add_button' %}false{% else %}true{% endif %}"
            data-id="{{ product.first_available_variant.id }}"
            data-skip-non-existent='true'
            data-skip-unavailable="{{ block.settings.skip_unavailable }}"
            {% if block.settings.update_prices %}
              data-update-prices='true'
              data-price="{{ price }}"
              data-compare-price="{% if compare_price > price %}{{ price }}{% else %}{{ compare_price }}{% endif %}"
              data-percentage-left="{{ percentage_left }}"
              data-fixed-discount="{{ fixed_discount }}"
              data-money-format="{{ shop.money_format }}"
            {% endif %}
          >
            {% if block.settings.container_title != blank and block.settings.container_title_position == 'inside' %}
              <h3
                class='cart-drawer-gift__progress center custom-font-size'
                style='--mobile-text-size: {{ block.settings.container_title_mobile_text_size | divided_by: 10.0 }}rem;--desktop-text-size: {{ block.settings.container_title_desktop_text_size | divided_by: 10.0 }}rem;'
              >
                {{ block.settings.container_title }}
              </h3>
            {% endif %}

            <div class='upsell__container{% if block.settings.toggle_element == "container" and block.settings.style != "add_button" %} upsell-toggle-btn{% endif %}'>

              {% if block.settings.show_images %}
                {%- liquid
                  if featured_image != blank
                    assign product_image = featured_image
                  else
                    assign product_image = product.featured_image
                  endif
                -%}
                {% if product_image != blank %}
                  <div class='upsell__image'>
                    <img
                      src="{{ product_image | image_url: width: 500, height: 500, crop: 'center' }}"
                      alt="{{ product_image.alt | escape }}"
                      class="upsell__image__img"
                      loading="lazy"
                      width="500"
                      height="500"
                    >
                  </div>
                {% endif %}
              {% endif %}

              <div class='upsell__content{% if block.settings.hide_compare_price %} hide-compare-price{% endif %}'>
                <div class='upsell__title'>
                  <h3>
                    {% if block.settings.title_link %}<a href='{{ product.url }}'>{% endif %}
                      {{ product.title
                        | replace: ' — Block Legends Figure', ''
                        | replace: ' – Block Legends Figure', ''
                        | replace: ' - Block Legends Figure', ''
                        | replace: '— Block Legends Figure', ''
                        | replace: '– Block Legends Figure', ''
                        | replace: '- Block Legends Figure', ''
                        | replace: ' — Block Legends', ''
                        | replace: ' – Block Legends', ''
                        | replace: ' - Block Legends', ''
                        | replace: '— Block Legends', ''
                        | replace: '– Block Legends', ''
                        | replace: '- Block Legends', ''
                        | strip
                      }}
                    {% if block.settings.title_link %}</a>{% endif %}
                  </h3>

                  {% if block.settings.price_position == 'next_to_title' %}
                    <div class='upsell__price'>
                      <span class='regular-price'>{{ price | money }}</span>
                      <span class='compare-price{% unless compare_price > price %} hidden{% endunless %}'>{{ compare_price | money }}</span>
                    </div>
                  {% endif %}
                </div>

                {%- unless description == blank -%}
                  <p class="upsell__desc">{{ description }}</p>
                {%- endunless -%}

                {%- unless product.has_only_default_variant -%}
                  {% if block.settings.show_variant_picker %}
                    <div class='upsell__variant-picker'>
                      {%- for option in product.options_with_values -%}
                        <div class="upsell__select select select--small no-background color-{{ settings.pickers_color_scheme }} accent-color-{{ settings.pickers_overlay_color }} accent-2-color-{{ settings.pickers_text_color }}">
                          <select class="select__select variant-dropdown" name="options[{{ option.name | escape }}]">
                            {% for value in option.values %}
                              {%- liquid
                                assign option_class = ''
                                assign option_disabled = true
                                assign option_exists = false

                                for option1_name in variants_option1_arr
                                  case option.position
                                    when 1
                                      if variants_option1_arr[forloop.index0] == value
                                        assign option_exists = true
                                        if variants_available_arr[forloop.index0]
                                          assign option_disabled = false
                                        endif
                                      endif
                                    when 2
                                      if option1_name == product.first_available_variant.option1 and variants_option2_arr[forloop.index0] == value
                                        assign option_exists = true
                                        if variants_available_arr[forloop.index0]
                                          assign option_disabled = false
                                        endif
                                      endif
                                    when 3
                                      if option1_name == product.first_available_variant.option1 and variants_option2_arr[forloop.index0] == product.first_available_variant.option2 and variants_option3_arr[forloop.index0] == value
                                        assign option_exists = true
                                        if variants_available_arr[forloop.index0]
                                          assign option_disabled = false
                                        endif
                                      endif
                                  endcase
                                endfor

                                if option_exists == false
                                  assign option_class = 'non-existent'
                                elsif option_disabled == true
                                  assign option_class = 'unavailable'
                                endif
                              -%}
                              <option value="{{ value | escape }}" class="{{ option_class }}">
                                {% if option_disabled -%}
                                  {{- 'products.product.value_unavailable' | t: option_value: value -}}
                                {%- else -%}
                                  {{- value -}}
                                {%- endif %}
                              </option>
                            {% endfor %}
                          </select>
                          {% render 'icon-caret' %}
                        </div>
                      {%- endfor -%}
                      <script type="application/json">
                        {{ product.variants | json }}
                      </script>
                    </div>
                  {% endif %}
                {%- endunless -%}

                {% if block.settings.price_position == 'separate' %}
                  <div class='upsell__price upsell__price--separate'>
                    <span class='regular-price'>{{ price | money }}</span>
                    <span class='compare-price{% unless compare_price > price %} hidden{% endunless %}'>{{ compare_price | money }}</span>
                  </div>
                {% endif %}
              </div>

              {% if block.settings.style == 'toggle_switch' %}
                <button class='upsell__toggle-switch toggle-switch{% if block.settings.toggle_element == "button" %} upsell-toggle-btn{% endif %}'>
                  <span class='toggle-switch__slider'>&nbsp;</span>
                </button>
              {% elsif block.settings.style == 'checkbox_1' %}
                <button class='upsell__checkbox flex-center{% if block.settings.toggle_element == "button" %} upsell-toggle-btn{% endif %}'>
                  {% render 'checkbox-icons' %}
                </button>
              {% elsif block.settings.style == 'checkbox_2' %}
                <button class='upsell__checkbox flex-center{% if block.settings.toggle_element == "button" %} upsell-toggle-btn{% endif %}'>
                  {% render 'material-icon', icon: 'add_circle', class: ' checkmark-unchecked' %}
                  {% render 'material-icon', icon: 'check_circle', filled: true, class: ' checkmark-checked' %}
                </button>
              {% elsif block.settings.style == 'plus_button' %}
                <button class='upsell__plus-btn{% if block.settings.toggle_element == "button" %} upsell-toggle-btn{% endif %}'>
                  {% render 'material-icon', icon: 'add', class: ' checkmark-unchecked' %}
                  {% render 'material-icon', icon: 'check', filled: true, class: ' checkmark-checked' %}
                </button>
              {% else %}
                <button
                  type="submit"
                  name="add"
                  class="upsell__add-btn button button--has-spinner"
                  form="{{ product_form_id }}"
                  id="DisplayedSubmitBtn-{{ section.id }}-{{ block.id }}-{{ forloop.index0 }}"
                  {% if product.first_available_variant.available == false %}disabled{% endif %}
                >
                  <span>
                    {%- if product.first_available_variant.available -%}
                      {{ block.settings.add_btn_label }}
                    {%- else -%}
                      {{ 'products.product.sold_out' | t }}
                    {%- endif -%}
                  </span>
                  <div class="loading-overlay__spinner">
                    <svg aria-hidden="true" focusable="false" class="spinner" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                      <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                    </svg>
                  </div>
                </button>
              {% endif %}

              <product-form{% if type == 'cart-drawer' %} data-is-cart-upsell='true'{% endif %} data-section="{{ section.id }}-{{ block.id }}-{{ forloop.index0 }}">
                {%- form 'product',
                  product,
                  id: product_form_id,
                  class: 'form',
                  novalidate: 'novalidate',
                  data-type: 'add-to-cart-form'
                -%}
                  <input type="hidden" name="id" value="{{ product.first_available_variant.id }}">
                  <button type='submit' class='hidden'>+</button>
                {%- endform -%}
              </product-form>

            </div>
          </{{ type }}-upsell>
        {%- endcapture -%}

        {% if display_count > 1 and block.settings.stacking == 'slider' %}
          <li class="splide__slide"><div class="splide__slide__container">{{ bl_upsell_card }}</div></li>
        {% else %}
          {{ bl_upsell_card }}
        {% endif %}
      {%- endif -%}

    {%- endfor -%}
  {%- endif -%}

  {%- comment -%}
    ADD-ON CARD (always rendered separately; JS keeps it visible)
  {%- endcomment -%}
  {%- if bl_addon_enabled -%}
    {%- liquid
  assign bl_is_slider = false
  if display_count > 1 and block.settings.stacking == 'slider'
    assign bl_is_slider = true
  endif

  assign addon_display = false
  if bl_addon_enabled and addon_product != blank
    assign addon_display = true

    if block.settings.hide_in_cart_items and block.settings.style == 'add_button'
      for item in cart.items
        if item.product.handle == addon_product.handle
          assign addon_display = false
          break
        endif
      endfor
    endif

    if addon_product.available == false
      assign addon_display = false
    endif

    # Keep totals correct in parent scope (render cannot mutate parent variables)
    assign bl_pool_total = bl_pool_total | plus: 1
    if addon_display == false
      assign hidden_products = hidden_products | plus: 1
    endif
  endif
-%}

{%- capture bl_addon_markup -%}
  {% render 'bl-upsells-addon',
    type: type,
    block: block,
    section: section,
    current_product: current_product,
    addon_product: addon_product,
    addon_display: addon_display,
    bl_pool_key: bl_pool_key,
    bl_pool_handle: bl_pool_handle,
    bl_pool_title: bl_pool_title,
    bl_is_slider: bl_is_slider
  %}
{%- endcapture -%}

{{ bl_addon_markup }}

  {%- endif -%}

  {% if display_count > 1 and block.settings.stacking == 'slider' %}
          </ul>
        </div>
      </div>
    </splide-component>
  {% endif %}
</div>

<div
  class="bl-addon-notice"
  data-bl-addon-notice
  role="status"
  aria-live="polite"
  aria-atomic="true"
  style="display:none;"
></div>

{%- if bl_pool_total > 0 and bl_pool_total == hidden_products -%}
  <style>
    #UpsellsBlock-{{ section.id }}-{{ block.id }} { display: none !important; }
  </style>
{%- endif -%}
