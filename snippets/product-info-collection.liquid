{%- comment -%}
  Product info: Collection line
  Expects: {% render 'product-info-collection', block: block, product: product, collection: collection %}
{%- endcomment -%}

{%- assign s = block.settings -%}

{%- comment %}
  Choose which collection to show:
  1) If product is viewed inside a collection page, use that (unless excluded).
  2) Otherwise fall back to the first collection the product belongs to (excluding catalog/all/frontpage).
{%- endcomment -%}
{%- liquid
  assign excluded_handles = 'catalog,all,frontpage' | split: ','
  assign pool_collection = nil

  if collection
    unless excluded_handles contains collection.handle
      assign pool_collection = collection
    endunless
  endif

  if pool_collection == nil and product != blank
    for product_collection in product.collections
      unless excluded_handles contains product_collection.handle
        assign pool_collection = product_collection
        break
      endunless
    endfor
  endif
-%}

{%- liquid
  assign bl_pool_key = product.metafields.custom.collection_key.value | default: product.metafields.custom.collection_key | strip | downcase
  assign bl_pool_handle = ''
  assign bl_pool_title = ''

  if pool_collection
    assign bl_pool_handle = pool_collection.handle | strip
    assign bl_pool_title = pool_collection.title | strip | escape
  endif

  if bl_pool_key == blank and bl_pool_handle != blank
    assign bl_pool_key = bl_pool_handle
  endif

  if bl_pool_handle == blank and bl_pool_key != blank
    assign bl_pool_handle = bl_pool_key
  endif

  if bl_pool_title == blank and bl_pool_key != blank
    assign bl_pool_title = bl_pool_key | replace: '-', ' ' | replace: '_', ' ' | capitalize | strip | escape
  endif
-%}

{%- comment -%}
  Canonical pool context for mystery add-on + rarity availability (consumed by JS).
{%- endcomment -%}
<div
  id="blPoolContext"
  data-bl-pool-key="{{ bl_pool_key }}"
  data-bl-pool-title="{{ bl_pool_title }}"
  data-bl-pool-handle="{{ bl_pool_handle }}"
  hidden
></div>

{%- assign bl_display_collection = pool_collection -%}
{%- if bl_display_collection -%}
  <p
    class="product-collection"
    style="
      --pc-mt: {{ s.margin_top | default: 0 }}px;
      --pc-mb: {{ s.margin_bottom | default: 8 }}px;
      --pc-fs: {{ s.font_size | default: 14 }}px;
    "
  >
    {%- if s.label != blank -%}
      <span class="product-collection__label">
        {{ s.label }}
      </span>
    {%- endif -%}

    {%- if s.show_link -%}
      <a class="product-collection__link" href="{{ bl_display_collection.url }}">
        {{ bl_display_collection.title }}
      </a>
    {%- else -%}
      <span class="product-collection__link">
        {{ bl_display_collection.title }}
      </span>
    {%- endif -%}
  </p>
{%- endif -%}
