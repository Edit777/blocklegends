{%- comment -%}
  Canonical pool context resolver for mystery pools.
  Primary: product.metafields.custom.collection_key (trimmed).
  Fallback: first product.collection handle not in [catalog, all, frontpage].
{%- endcomment -%}

{%- liquid
  assign excluded_handles = 'catalog,all,frontpage' | split: ','
  assign bl_pool_key = product.metafields.custom.collection_key.value | default: product.metafields.custom.collection_key | strip
  assign pool_collection = nil

  if bl_pool_key == blank
    if collection
      unless excluded_handles contains collection.handle
        assign pool_collection = collection
      endunless
    endif

    if pool_collection == nil and product != blank
      for product_collection in product.collections
        unless excluded_handles contains product_collection.handle
          assign pool_collection = product_collection
          break
        endunless
      endfor
    endif
  endif

  assign bl_pool_handle = bl_pool_key
  if bl_pool_handle == blank and pool_collection
    assign bl_pool_handle = pool_collection.handle | strip
  endif

  if bl_pool_key == blank and bl_pool_handle != blank
    assign bl_pool_key = bl_pool_handle
  endif

  assign bl_pool_title = ''
  if bl_pool_handle != blank
    assign bl_pool_collection = collections[bl_pool_handle]
    if bl_pool_collection
      assign bl_pool_title = bl_pool_collection.title | strip | escape
    endif
  endif

  if bl_pool_title == blank and pool_collection and pool_collection.handle == bl_pool_handle
    assign bl_pool_title = pool_collection.title | strip | escape
  endif

  if bl_pool_title == blank and bl_pool_handle != blank
    assign bl_pool_title = bl_pool_handle | replace: '-', ' ' | replace: '_', ' ' | capitalize | strip | escape
  endif
-%}

<div
  id="blPoolContext"
  data-bl-pool-handle="{{ bl_pool_handle }}"
  data-bl-pool-key="{{ bl_pool_key }}"
  data-bl-pool-title="{{ bl_pool_title }}"
  hidden
></div>
